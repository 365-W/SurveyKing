(self.webpackChunksurvey_king=self.webpackChunksurvey_king||[]).push([[6637],{78210:function(ue,N,s){"use strict";var Y=s(27856),M=s.n(Y),S=s(15020),c=s(85893),D=function(V){var j=V.html,k=j===void 0?"":j,F=V.replaceP,E=F===void 0?!0:F;return E?(0,c.jsx)("div",{className:"pe-view",children:typeof k=="string"&&(0,S.ZP)(M().sanitize(k,{ADD_TAGS:["iframe"],ADD_ATTR:["allow","allowfullscreen","frameborder","scrolling"]}).replace(/<p>/,"<span>").replace(/<\/p>/,"</span>"))}):(0,c.jsx)(c.Fragment,{children:typeof k=="string"&&(0,S.ZP)(M().sanitize(k))})};N.Z=D},47488:function(ue,N,s){"use strict";s.r(N),s.d(N,{MobileOrPC:function(){return ee},default:function(){return Oe}});var Y=s(34792),M=s(48086),S=s(11849),c=s(39428),D=s(3182),q=s(68068),V=s(9761),j=s(67294),k=s(51615),F=s(92725),E=s(12997),be=s(49111),le=s(19650),Re=s(57663),Q=s(71577),de=s(94657),L=s(3980),ve=s(27400),ce=s(73727),fe=s(49914),T=s(87998),i=s(85893),he=(0,V.Pi)(function(){var I,o,e=(0,fe.H)(),l=(0,ve.a)(),r=e.success,u=(I=e.setting)===null||I===void 0?void 0:I.submittedSetting,d=(o=e.setting)===null||o===void 0?void 0:o.answerSetting.loginRequired,a=e.survey,f=e.id,h=(0,j.useMemo)(function(){return a?(0,T.R6)(a):{}},[a]),g=u||{},n=g.contentHtml,O=g.redirectUrl,Z=g.answerAnalysis,p=g.rankVisible,H=g.transcriptVisible,w=e.answerId,b=e.answerQrCodeUrl,x=e.answerView,A=e.values;(0,j.useEffect)(function(){if(O&&A){if(!O.includes("(")){window.location.href=O;return}var C=(0,T.vW)(O,function(P){var W=(0,T.Op)(P),B=(0,de.Z)(W,2),J=B[0],re=B[1],z=A[J];return(0,T.d0)(h,z,P)});C.success&&(window.location.href=C.result)}},[O,A]),(0,j.useEffect)(function(){r&&a&&A&&x&&(0,T.MA)(a,n,A,x.examScore)},[n,r,a,A,x]);var K=function(){var P="";return Z&&p?P="\u67E5\u770B\u6392\u540D\u53CA\u89E3\u6790":p?P="\u67E5\u770B\u8003\u8BD5\u6392\u540D":Z&&(P="\u67E5\u770B\u7B54\u6848\u89E3\u6790"),P?(0,i.jsx)("div",{children:(0,i.jsx)(Q.Z,{onClick:function(){return window.open("/s/".concat(f,"/exam-result/").concat(w))},children:P})}):(0,i.jsx)(i.Fragment,{})};return r?(0,i.jsx)("div",{className:"survey-end animated",children:(0,i.jsx)("div",{className:"survey-end-content",children:(0,i.jsx)("h3",{className:"survey-end-title ",children:(0,i.jsxs)("div",{children:[(0,i.jsx)("div",{id:"result-message"}),K(),(0,i.jsx)("div",{children:d&&(0,i.jsxs)(le.Z,{children:[(0,i.jsx)(ce.rU,{to:"/",children:(0,i.jsx)(Q.Z,{type:"link",onClick:function(){},children:"\u8FD4\u56DE\u9996\u9875"})}),(0,i.jsx)(Q.Z,{type:"link",onClick:function(){l.logout(),(0,L.on)()},children:"\u9000\u51FA\u5173\u95ED"})]})})]})})})}):(0,i.jsx)(i.Fragment,{})}),me=he,ge=s(78210),pe=s(69610),we=s(54941),t=s(54531),_=s(36855),ye=s(42238),je=s.n(ye),Ie=function(){function I(o){var e;(0,pe.Z)(this,I),this.id=void 0,this.project=void 0,this.survey=void 0,this.loading=void 0,this.verifying=!1,this.saving=!1,this.isPC=void 0,this.errorCode=void 0,this.errorMessage=void 0,this.progress=0,this.confirmTempAnswerType=0,this.statistics=void 0,this.answerUrl=void 0,this.answerQrCodeUrl=void 0,this.loginRequired=void 0,this.whitelistName=void 0,this.success=void 0,this.answerId=void 0,this.answerView=void 0,this.values=void 0,this.openId=void 0,this.token=void 0,this.surveyRef=void 0,this.id=o.id,this.answerId=o.answerId,this.surveyRef=o.surveyRef;var l=_.parse(window.location.search);l&&(this.openId=l.openId,this.token=l["sk-token"]),this.makeObservable(),this.loadProject(),this.confirmTempAnswerType=(e=this.savedAnswer)!==null&&e!==void 0&&e.progress?1:0}return(0,we.Z)(I,[{key:"makeObservable",value:function(){(0,t.Ou)(this,{id:t.LO.ref,answerId:t.LO.ref,survey:t.LO.ref,loading:t.LO.ref,saving:t.LO.ref,verifying:t.LO.ref,project:t.LO.ref,errorCode:t.LO.ref,errorMessage:t.LO.ref,progress:t.LO.ref,confirmTempAnswerType:t.LO.ref,statistics:t.LO.ref,answerUrl:t.LO.ref,answerQrCodeUrl:t.LO.ref,success:t.LO.ref,answerView:t.LO.ref,values:t.LO.ref,loginRequired:t.LO.ref,whitelistName:t.LO.ref,openId:t.LO.ref,token:t.LO.ref,passwordRequired:t.LO.computed,mode:t.LO.computed,tempSaveId:t.LO.computed,status:t.LO.computed,setting:t.LO.computed,tempSave:t.aD,saveData:t.aD,loadProject:t.aD,changeProgress:t.aD,validate:t.aD})}},{key:"setting",get:function(){var e;return(e=this.project)===null||e===void 0?void 0:e.setting}},{key:"status",get:function(){var e;return(e=this.project)===null||e===void 0?void 0:e.status}},{key:"passwordRequired",get:function(){var e;return(e=this.project)===null||e===void 0?void 0:e.passwordRequired}},{key:"mode",get:function(){var e;return(e=this.project)===null||e===void 0?void 0:e.mode}},{key:"tempSaveId",get:function(){return"savedAnswer-"+this.id}},{key:"savedAnswer",get:function(){var e=localStorage.getItem(this.tempSaveId);return e&&JSON.parse(e)}},{key:"startTime",get:function(){var e,l,r;return((e=this.savedAnswer)===null||e===void 0||(l=e.metaInfo)===null||l===void 0||(r=l.answerInfo)===null||r===void 0?void 0:r.startTime)||new Date().getTime()}},{key:"tempSave",value:function(e){var l=localStorage.getItem(this.tempSaveId),r;l?(r=JSON.parse(l),r.answer=e,r.progress=this.progress):r={answer:e,metaInfo:{answerInfo:{startTime:new Date().getTime()}},progress:this.progress},localStorage.setItem(this.tempSaveId,JSON.stringify(r))}},{key:"saveData",value:function(){var o=(0,D.Z)((0,c.Z)().mark(function l(r,u){var d,a,f=this,h,g,n,O,Z,p;return(0,c.Z)().wrap(function(w){for(;;)switch(w.prev=w.next){case 0:if(this.saving=!0,h=new(je())().getResult(),g={answer:r,projectId:this.id,metaInfo:{answerInfo:{startTime:this.startTime,endTime:new Date().getTime()},clientInfo:{browser:h.browser.name||"",browserVersion:h.browser.version||"",deviceType:h.device.type||"",platform:h.os.name||"",platformVersion:h.os.version||""}},id:u||this.answerId,whitelistName:this.whitelistName},n=this.startTime,O=((d=this.project)===null||d===void 0||(a=d.setting.examSetting)===null||a===void 0?void 0:a.minSubmitMinutes)||0,Z=n+O*60*1e3,!(O>0&&new Date().getTime()<Z)){w.next=10;break}return M.default.error("\u672A\u5230\u4EA4\u5377\u65F6\u95F4"),this.saving=!1,w.abrupt("return");case 10:return w.next=12,L.hi.post(this.getUrlWithToken("/api/public/saveAnswer"),g);case 12:return p=w.sent,(0,t.aD)(function(){p.success&&(p.data.answerId?f.answerId=p.data.answerId:p.data.examScore!==void 0,f.answerView=p.data,f.values=r,f.success=!0,localStorage.removeItem(f.tempSaveId)),f.saving=!1}),w.abrupt("return",p);case 15:case"end":return w.stop()}},l,this)}));function e(l,r){return o.apply(this,arguments)}return e}()},{key:"loadStatistics",value:function(){var o=(0,D.Z)((0,c.Z)().mark(function l(){var r=this,u;return(0,c.Z)().wrap(function(a){for(;;)switch(a.prev=a.next){case 0:if(!this.loading){a.next=2;break}return a.abrupt("return");case 2:return this.loading=!0,a.next=5,L.hi.post(this.getUrlWithToken("/api/public/statistics"),{id:this.id});case 5:u=a.sent,(0,t.aD)(function(){u.success&&(r.statistics=u.data),r.loading=!1});case 7:case"end":return a.stop()}},l,this)}));function e(){return o.apply(this,arguments)}return e}()},{key:"loadProject",value:function(){var o=(0,D.Z)((0,c.Z)().mark(function l(){var r=this,u;return(0,c.Z)().wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return this.loading=!0,a.next=3,L.hi.post(this.getUrlWithToken("/api/public/loadProject"),{id:this.id,answerId:this.answerId});case 3:u=a.sent,(0,t.aD)(function(){u.success?(r.project=u.data,r.loginRequired=u.data.loginRequired,r.survey=u.data.survey,r.values=u.data.answer,u.data.answerId&&(r.answerId=u.data.answerId)):r.errorMessage=u.message,r.errorCode=u.code,r.loading=!1});case 5:case"end":return a.stop()}},l,this)}));function e(){return o.apply(this,arguments)}return e}()},{key:"validate",value:function(){var o=(0,D.Z)((0,c.Z)().mark(function l(r){var u=this,d;return(0,c.Z)().wrap(function(f){for(;;)switch(f.prev=f.next){case 0:return this.verifying=!0,f.next=3,L.hi.post(this.getUrlWithToken("/api/public/validateProject"),{id:this.id,answer:r,answerId:this.answerId});case 3:d=f.sent,(0,t.aD)(function(){if(d.success){var h;u.project=d.data,u.loginRequired=!1,u.survey=d.data.survey,u.whitelistName=(h=r.whitelistName)===null||h===void 0?void 0:h.whitelistName}else M.default.error(d.message);u.verifying=!1});case 5:case"end":return f.stop()}},l,this)}));function e(l){return o.apply(this,arguments)}return e}()},{key:"upload",value:function(){var o=(0,D.Z)((0,c.Z)().mark(function l(r,u){return(0,c.Z)().wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return a.abrupt("return",L.hi.upload("/api/public/upload",(0,S.Z)({fileType:4,basePath:this.id},r),u));case 1:case"end":return a.stop()}},l,this)}));function e(l,r){return o.apply(this,arguments)}return e}()},{key:"changeProgress",value:function(e){this.progress=e}},{key:"getUrlWithToken",value:function(e){return _.stringifyUrl({url:e,query:{"sk-token":this.token}})}}]),I}(),ee=(0,V.Pi)(function(){var I,o,e=(0,k.UO)(),l=e.id,r=e.answerId,u=(0,k.TH)(),d=u.query.preview==="1",a=u.query.pattern,f=u.query.openid,h=(0,j.useMemo)(function(){return(0,T.SB)()},[]),g=(0,j.useRef)(null),n=(0,j.useMemo)(function(){return new Ie({surveyRef:g,id:l,answerId:r})},[g,l,r]),O=n.saving,Z=n.loading,p=(I=n.setting)===null||I===void 0?void 0:I.answerSetting,H=n.loginRequired,w=n.verifying,b=p||{},x=b.autoSave,A=b.progressBar,K=b.initialValues,C=b.questionNumber,P=b.wechatOnly,W=b.onePageOneQuestion,B=b.answerSheetVisible,J=((o=n.setting)===null||o===void 0?void 0:o.examSetting)||{},re=J.exerciseMode,z=n.errorMessage,G=n.savedAnswer,se=n.confirmTempAnswerType,Se=n.statistics,U=n.survey,te=n.answerId,ie=n.mode,ae=n.success,ne=(0,T.XO)(U,u);(0,j.useEffect)(function(){U&&(0,T.iq)(U,"statEnabled")&&n.loadStatistics()},[U,n]);var Te=(0,j.useCallback)(function($,y){A&&n.changeProgress(y),x&&$&&n.tempSave($)},[A]),Ae=function(){return(0,i.jsx)(E.BW,{})},oe=function(y){var m,v;return(0,i.jsxs)("div",{className:"render-failure ".concat(h?"mobile":"phone"),children:[((m=n.project)===null||m===void 0?void 0:m.name)&&(0,i.jsx)("div",{className:"title",children:(v=n.project)===null||v===void 0?void 0:v.name}),(0,i.jsxs)("div",{className:"content",children:[(0,i.jsx)("div",{children:(0,i.jsx)(E.AT,{})}),(0,i.jsx)("h2",{children:z||y}),(0,i.jsx)("div",{children:"\u611F\u8C22\u5173\u6CE8\uFF01"})]})]})},Pe=function(){if(ae)return(0,i.jsx)(i.Fragment,{});if(Z)return(0,i.jsx)(F.Z,{});if(n.errorCode!==200)return oe();if(P&&!(0,T.CL)())return oe("\u53EA\u80FD\u5728\u5FAE\u4FE1\u4E2D\u6253\u5F00");if(H)return(0,i.jsx)("div",{children:Ae()});if(U&&!ae&&!w)return se===1&&x&&ie==="survey"&&!te?(0,i.jsx)(E.oq,{}):(0,i.jsx)(q.Z,{ref:g,mode:ie,loading:O||Z,progressBar:A,questionNumber:C,theme:h?"antdMobile":"antd",schema:U,onChange:Te,onePageOneQuestion:W,answerSheetVisible:B,exerciseMode:re,pattern:a,onInit:function(m){n.tempSave(m.values)},onDictSearch:function(){var y=(0,D.Z)((0,c.Z)().mark(function m(v){var X;return(0,c.Z)().wrap(function(R){for(;;)switch(R.prev=R.next){case 0:return R.next=2,L.hi.loadDict(v);case 2:if(X=R.sent,!X.success){R.next=5;break}return R.abrupt("return",X.data);case 5:return R.abrupt("return",[]);case 6:case"end":return R.stop()}},m)}));return function(m){return y.apply(this,arguments)}}(),initialValues:se===3?ne:(0,S.Z)((0,S.Z)((0,S.Z)((0,S.Z)({},K),x?G==null?void 0:G.answer:{}),ne),n.values),statistics:Se,onUpload:function(m,v){return n.upload(m,v)},footerVisible:!(d||a==="readPretty"),headerVisible:!d,isPreview:d,onSubmit:function(m){n.saveData((0,S.Z)((0,S.Z)({},m),{},{openid:f}),te).then(function(v){!(v!=null&&v.success)&&v!==null&&v!==void 0&&v.message&&M.default.error((0,i.jsx)(ge.Z,{html:v.message}))})}})},De=function(){return(0,i.jsx)(me,{})},Ze=function(){var y,m,v=(y=n.survey)===null||y===void 0||(m=y.attribute)===null||m===void 0?void 0:m.backgroundImage;if(v)return{backgroundImage:"url(/api/public/preview/".concat(v,")")}};return(0,i.jsx)(T.ff.Provider,{value:n,children:(0,i.jsxs)("div",{className:"survey ".concat(h?"mobile":"pc"),style:Ze(),children:[Pe(),De()]})})}),Oe=ee}}]);
