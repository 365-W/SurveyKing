(self.webpackChunksurvey_king=self.webpackChunksurvey_king||[]).push([[6637],{78210:function(fe,N,r){"use strict";var q=r(27856),F=r.n(q),j=r(15020),h=r(85893),R=function($){var W=$.html,y=W===void 0?"":W,M=$.replaceP,K=M===void 0?!0:M;return K?(0,h.jsx)("div",{className:"pe-view",children:typeof y=="string"&&(0,j.ZP)(F().sanitize(y,{ADD_TAGS:["iframe"],ADD_ATTR:["allow","allowfullscreen","frameborder","scrolling"]}).replace(/<p>/,"<span>").replace(/<\/p>/,"</span>"))}):(0,h.jsx)(h.Fragment,{children:typeof y=="string"&&(0,j.ZP)(F().sanitize(y))})};N.Z=R},47488:function(fe,N,r){"use strict";r.r(N),r.d(N,{MobileOrPC:function(){return se},default:function(){return Ae}});var q=r(71194),F=r(50146),j=r(11849),h=r(39428),R=r(3182),_=r(68068),$=r(9761),W=r(42277),y=r(67294),M=r(51615),K=r(92725),J=r(12997),Ve=r(49111),he=r(19650),Ue=r(57663),z=r(71577),ge=r(94657),x=r(3980),me=r(27400),pe=r(73727),ye=r(49914),Z=r(96389),i=r(85893),we=(0,$.Pi)(function(){var T,o,e=(0,ye.H)(),l=(0,me.a)(),t=e.success,u=(T=e.setting)===null||T===void 0?void 0:T.submittedSetting,f=(o=e.setting)===null||o===void 0?void 0:o.answerSetting.loginRequired,a=e.survey,c=e.id,g=(0,y.useMemo)(function(){return a?(0,Z.R6)(a):{}},[a]),A=u||{},P=A.contentHtml,p=A.redirectUrl,n=A.answerAnalysis,I=A.rankVisible,V=A.transcriptVisible,S=e.answerId,ie=e.answerQrCodeUrl,U=e.answerView,m=e.values;(0,y.useEffect)(function(){if(p&&m){if(!p.includes("(")){window.location.href=p;return}var L=(0,Z.vW)(p,function(D){var B=(0,Z.Op)(D),Q=(0,ge.Z)(B,2),G=Q[0],ae=Q[1],X=m[G];return(0,Z.d0)(g,X,D)});L.success&&(window.location.href=L.result)}},[p,m]),(0,y.useEffect)(function(){t&&a&&m&&U&&(0,Z.MA)(a,P,m,U.examScore)},[P,t,a,m,U]);var E=function(){var D="";return n&&I?D="\u67E5\u770B\u6392\u540D\u53CA\u89E3\u6790":I?D="\u67E5\u770B\u8003\u8BD5\u6392\u540D":(n||V)&&(D="\u67E5\u770B\u7B54\u6848\u89E3\u6790"),D?(0,i.jsx)("div",{children:(0,i.jsx)(z.Z,{onClick:function(){return window.open("/s/".concat(c,"/exam-result/").concat(S))},children:D})}):(0,i.jsx)(i.Fragment,{})};return t?(0,i.jsx)("div",{className:"survey-end animated",children:(0,i.jsx)("div",{className:"survey-end-content",children:(0,i.jsx)("h3",{className:"survey-end-title ",children:(0,i.jsxs)("div",{children:[(0,i.jsx)("div",{id:"result-message"}),E(),(0,i.jsx)("div",{children:f&&(0,i.jsxs)(he.Z,{children:[(0,i.jsx)(pe.rU,{to:"/",children:(0,i.jsx)(z.Z,{type:"link",onClick:function(){},children:"\u8FD4\u56DE\u9996\u9875"})}),(0,i.jsx)(z.Z,{type:"link",onClick:function(){l.logout(),(0,x.on)()},children:"\u9000\u51FA\u5173\u95ED"})]})})]})})})}):(0,i.jsx)(i.Fragment,{})}),je=we,ee=r(78210),Ee=r(34792),re=r(48086),Ie=r(69610),Se=r(54941),s=r(54531),te=r(36855),Oe=r(42238),Te=r.n(Oe),Ze=function(){function T(o){var e;(0,Ie.Z)(this,T),this.id=void 0,this.project=void 0,this.survey=void 0,this.loading=void 0,this.verifying=!1,this.saving=!1,this.isPC=void 0,this.errorCode=void 0,this.errorMessage=void 0,this.progress=0,this.confirmTempAnswerType=0,this.statistics=void 0,this.answerUrl=void 0,this.answerQrCodeUrl=void 0,this.loginRequired=void 0,this.whitelistName=void 0,this.success=void 0,this.answerId=void 0,this.answerView=void 0,this.values=void 0,this.openId=void 0,this.token=void 0,this.surveyRef=void 0,this.id=o.id,this.answerId=o.answerId,this.surveyRef=o.surveyRef;var l=te.parse(window.location.search);l&&(this.openId=l.openId,this.token=l["sk-token"]),this.makeObservable(),this.loadProject(),this.confirmTempAnswerType=(e=this.savedAnswer)!==null&&e!==void 0&&e.progress?1:0}return(0,Se.Z)(T,[{key:"makeObservable",value:function(){(0,s.Ou)(this,{id:s.LO.ref,answerId:s.LO.ref,survey:s.LO.ref,loading:s.LO.ref,saving:s.LO.ref,verifying:s.LO.ref,project:s.LO.ref,errorCode:s.LO.ref,errorMessage:s.LO.ref,progress:s.LO.ref,confirmTempAnswerType:s.LO.ref,statistics:s.LO.ref,answerUrl:s.LO.ref,answerQrCodeUrl:s.LO.ref,success:s.LO.ref,answerView:s.LO.ref,values:s.LO.ref,loginRequired:s.LO.ref,whitelistName:s.LO.ref,openId:s.LO.ref,token:s.LO.ref,passwordRequired:s.LO.computed,mode:s.LO.computed,tempSaveId:s.LO.computed,status:s.LO.computed,setting:s.LO.computed,tempSave:s.aD,saveData:s.aD,loadProject:s.aD,changeProgress:s.aD,validate:s.aD})}},{key:"setting",get:function(){var e;return(e=this.project)===null||e===void 0?void 0:e.setting}},{key:"status",get:function(){var e;return(e=this.project)===null||e===void 0?void 0:e.status}},{key:"passwordRequired",get:function(){var e;return(e=this.project)===null||e===void 0?void 0:e.passwordRequired}},{key:"mode",get:function(){var e;return(e=this.project)===null||e===void 0?void 0:e.mode}},{key:"tempSaveId",get:function(){return"savedAnswer-"+this.id}},{key:"savedAnswer",get:function(){var e=localStorage.getItem(this.tempSaveId);return e&&JSON.parse(e)}},{key:"startTime",get:function(){var e,l,t;return((e=this.savedAnswer)===null||e===void 0||(l=e.metaInfo)===null||l===void 0||(t=l.answerInfo)===null||t===void 0?void 0:t.startTime)||new Date().getTime()}},{key:"tempSave",value:function(e){var l=localStorage.getItem(this.tempSaveId),t;l?(t=JSON.parse(l),t.answer=e,t.progress=this.progress):t={answer:e,metaInfo:{answerInfo:{startTime:new Date().getTime()}},progress:this.progress},localStorage.setItem(this.tempSaveId,JSON.stringify(t))}},{key:"saveData",value:function(){var o=(0,R.Z)((0,h.Z)().mark(function l(t,u){var f,a,c=this,g,A,P,p,n,I;return(0,h.Z)().wrap(function(S){for(;;)switch(S.prev=S.next){case 0:if(this.saving=!0,g=new(Te())().getResult(),A={answer:t,projectId:this.id,metaInfo:{answerInfo:{startTime:this.startTime,endTime:new Date().getTime()},clientInfo:{browser:g.browser.name||"",browserVersion:g.browser.version||"",deviceType:g.device.type||"",platform:g.os.name||"",platformVersion:g.os.version||""}},id:u||this.answerId,whitelistName:this.whitelistName},P=this.startTime,p=((f=this.project)===null||f===void 0||(a=f.setting.examSetting)===null||a===void 0?void 0:a.minSubmitMinutes)||0,n=P+p*60*1e3,!(p>0&&new Date().getTime()<n)){S.next=10;break}return re.default.error("\u672A\u5230\u4EA4\u5377\u65F6\u95F4"),this.saving=!1,S.abrupt("return");case 10:return S.next=12,x.hi.post(this.getUrlWithToken("/api/public/saveAnswer"),A);case 12:return I=S.sent,(0,s.aD)(function(){I.success&&(I.data.answerId?c.answerId=I.data.answerId:I.data.examScore!==void 0,c.answerView=I.data,c.values=t,c.success=!0,localStorage.removeItem(c.tempSaveId)),c.saving=!1}),S.abrupt("return",I);case 15:case"end":return S.stop()}},l,this)}));function e(l,t){return o.apply(this,arguments)}return e}()},{key:"loadStatistics",value:function(){var o=(0,R.Z)((0,h.Z)().mark(function l(){var t=this,u;return(0,h.Z)().wrap(function(a){for(;;)switch(a.prev=a.next){case 0:if(!this.loading){a.next=2;break}return a.abrupt("return");case 2:return this.loading=!0,a.next=5,x.hi.post(this.getUrlWithToken("/api/public/statistics"),{id:this.id});case 5:u=a.sent,(0,s.aD)(function(){u.success&&(t.statistics=u.data),t.loading=!1});case 7:case"end":return a.stop()}},l,this)}));function e(){return o.apply(this,arguments)}return e}()},{key:"loadProject",value:function(){var o=(0,R.Z)((0,h.Z)().mark(function l(){var t=this,u;return(0,h.Z)().wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return this.loading=!0,a.next=3,x.hi.post(this.getUrlWithToken("/api/public/loadProject"),{id:this.id,answerId:this.answerId});case 3:u=a.sent,(0,s.aD)(function(){u.success?(t.project=u.data,t.loginRequired=u.data.loginRequired,t.survey=u.data.survey,t.values=u.data.answer,u.data.answerId&&(t.answerId=u.data.answerId)):t.errorMessage=u.message,t.errorCode=u.code,t.loading=!1});case 5:case"end":return a.stop()}},l,this)}));function e(){return o.apply(this,arguments)}return e}()},{key:"validate",value:function(){var o=(0,R.Z)((0,h.Z)().mark(function l(t){var u=this,f;return(0,h.Z)().wrap(function(c){for(;;)switch(c.prev=c.next){case 0:return this.verifying=!0,c.next=3,x.hi.post(this.getUrlWithToken("/api/public/validateProject"),{id:this.id,answer:t,answerId:this.answerId});case 3:f=c.sent,(0,s.aD)(function(){if(f.success){var g;u.project=f.data,u.loginRequired=!1,u.survey=f.data.survey,u.whitelistName=(g=t.whitelistName)===null||g===void 0?void 0:g.whitelistName}else re.default.error(f.message);u.verifying=!1});case 5:case"end":return c.stop()}},l,this)}));function e(l){return o.apply(this,arguments)}return e}()},{key:"upload",value:function(){var o=(0,R.Z)((0,h.Z)().mark(function l(t,u){return(0,h.Z)().wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return a.abrupt("return",x.hi.upload("/api/public/upload",(0,j.Z)({fileType:4,basePath:this.id},t),u));case 1:case"end":return a.stop()}},l,this)}));function e(l,t){return o.apply(this,arguments)}return e}()},{key:"changeProgress",value:function(e){this.progress=e}},{key:"getUrlWithToken",value:function(e){return te.stringifyUrl({url:e,query:{"sk-token":this.token}})}}]),T}(),se=(0,$.Pi)(function(){var T,o,e,l,t=(0,M.UO)(),u=t.id,f=t.answerId,a=(0,M.TH)(),c=a.query.preview==="1",g=a.query.pattern,A=a.query.openid,P=(0,y.useMemo)(function(){return(0,Z.SB)()},[]),p=(0,y.useRef)(null),n=(0,y.useMemo)(function(){return new Ze({surveyRef:p,id:u,answerId:f})},[p,u,f]),I=n.saving,V=n.loading,S=(T=n.setting)===null||T===void 0?void 0:T.answerSetting,ie=n.loginRequired,U=n.verifying,m=S||{},E=m.autoSave,L=m.progressBar,D=m.initialValues,B=m.questionNumber,Q=m.wechatOnly,G=m.onePageOneQuestion,ae=m.answerSheetVisible,X=m.triggerType,Pe=((o=n.setting)===null||o===void 0?void 0:o.examSetting)||{},De=Pe.exerciseMode,Le=!!((e=n.setting)!==null&&e!==void 0&&(l=e.examSetting)!==null&&l!==void 0&&l.randomSurveyWrong),Re=n.errorMessage,Y=n.savedAnswer,ne=n.confirmTempAnswerType,xe=n.statistics,b=n.survey,oe=n.answerId,ue=n.mode,le=n.success,de=(0,Z.XO)(b,a);(0,y.useEffect)(function(){b&&(0,Z.iq)(b,"statEnabled","quota")&&n.loadStatistics()},[b,n]);var ke=(0,y.useCallback)(function(k,w){L&&n.changeProgress(w),E&&k&&n.tempSave(k)},[L]),be=function(){return(0,i.jsx)(J.BW,{})},ve=function(w){var v,d;return(0,i.jsxs)("div",{className:"render-failure ".concat(P?"mobile":"phone"),children:[((v=n.project)===null||v===void 0?void 0:v.name)&&(0,i.jsx)("div",{className:"title",children:(d=n.project)===null||d===void 0?void 0:d.name}),(0,i.jsxs)("div",{className:"content",children:[(0,i.jsx)("div",{children:(0,i.jsx)(J.AT,{})}),(0,i.jsx)("h2",{children:Re||w}),(0,i.jsx)("div",{children:"\u611F\u8C22\u5173\u6CE8\uFF01"})]})]})},Ce=function(){if(le)return(0,i.jsx)(i.Fragment,{});if(V)return(0,i.jsx)(K.Z,{});if(n.errorCode!==200)return ve();if(Q&&!(0,Z.CL)())return ve("\u53EA\u80FD\u5728\u5FAE\u4FE1\u4E2D\u6253\u5F00");if(ie)return(0,i.jsx)("div",{children:be()});if(b&&!le&&!U)return ne===1&&E&&ue==="survey"&&!oe?(0,i.jsx)(J.oq,{}):(0,i.jsx)(_.Z,{ref:p,mode:ue,loading:I||V,progressBar:L,questionNumber:B,theme:P?"antdMobile":"antd",schema:b,onChange:ke,onePageOneQuestion:G,answerSheetVisible:ae,exerciseMode:De,wrongMode:Le,pattern:g,triggerType:X,onInit:function(v){n.tempSave(v.values)},onDictSearch:function(){var w=(0,R.Z)((0,h.Z)().mark(function v(d){var C;return(0,h.Z)().wrap(function(O){for(;;)switch(O.prev=O.next){case 0:return O.next=2,x.hi.loadDict(d);case 2:if(C=O.sent,!C.success){O.next=5;break}return O.abrupt("return",C.data);case 5:return O.abrupt("return",[]);case 6:case"end":return O.stop()}},v)}));return function(v){return w.apply(this,arguments)}}(),initialValues:ne===3?de:(0,j.Z)((0,j.Z)((0,j.Z)((0,j.Z)({},D),E?Y==null?void 0:Y.answer:{}),de),n.values),statistics:xe,onUpload:function(v,d){return n.upload(v,d)},footerVisible:!(c||g==="readPretty"),headerVisible:!c,isPreview:c,onLink:function(v){console.log(v),x.hi.loadLinkResult((0,j.Z)((0,j.Z)({},v),{},{projectId:u})).then(function(d){if(d.success&&d.data.answer){var C=d.data.answer;Object.keys(C).forEach(function(H){var O,ce=C[H];(O=p.current)===null||O===void 0||O.setValue(H,ce),console.log(H,ce)})}})},onSubmit:function(v){n.saveData((0,j.Z)((0,j.Z)({},v),{},{openid:A}),oe).then(function(d){!(d!=null&&d.success)&&d!==null&&d!==void 0&&d.message&&(P?W.u_.alert({title:"\u4FDD\u5B58\u5931\u8D25",content:(0,i.jsx)(ee.Z,{html:d.message})}):F.Z.error({title:"\u4FDD\u5B58\u5931\u8D25",content:(0,i.jsx)(ee.Z,{html:d.message}),okText:"\u77E5\u9053\u4E86"}))})}})},$e=function(){return(0,i.jsx)(je,{})},Me=function(){var w,v,d=(w=n.survey)===null||w===void 0||(v=w.attribute)===null||v===void 0?void 0:v.backgroundImage;if(d)return{backgroundImage:"url(/api/public/preview/".concat(d,")")}};return(0,i.jsx)(Z.ff.Provider,{value:n,children:(0,i.jsxs)("div",{className:"survey ".concat(P?"mobile":"pc"),style:Me(),children:[Ce(),$e()]})})}),Ae=se}}]);
